# üõ†Ô∏è Ferramentas e Servi√ßos do Radar

## üìã Stack Tecnol√≥gico

A ingest√£o do Radar utiliza uma stack moderna e robusta para garantir alta disponibilidade, performance e confiabilidade no pipeline de dados.

## üîß Airbyte - Plataforma de Integra√ß√£o

### **Vers√£o e Configura√ß√£o**
- **Vers√£o Airbyte**: 0.3.23
- **Source Connector**: airbyte/source-mysql v3.0.0
- **Destination Connector**: airbyte/destination-s3 v0.3.23
- **Deployment**: Kubernetes com Helm Charts

### **Caracter√≠sticas Principais**

#### **Source MySQL Connector**
```yaml
# Capacidades do Connector
connector_features:
  - name: "Full Refresh Sync"
    supported: true
  - name: "Incremental Sync"
    supported: true
  - name: "Change Data Capture (CDC)"
    supported: true
  - name: "SSL Support"
    supported: true
  - name: "SSH Tunnel"
    supported: true
  - name: "Normalization"
    supported: false
  - name: "DBT Support"
    supported: false
```

#### **Destination S3 Connector**
```yaml
# Formatos Suportados
supported_formats:
  - CSV
  - JSON Lines
  - Parquet (em uso)
  
# Tipos de Compress√£o
compression_options:
  - No Compression
  - GZIP
  - SNAPPY (em uso)
  - DEFLATE
  - BZIP2
  - XZ
  - ZSTANDARD
```

### **Configura√ß√£o de Performance**

#### **Resource Requirements**
```yaml
# Configura√ß√£o de recursos
resource_requirements:
  cpu_limit: "2000m"       # 2 CPU cores
  cpu_request: "500m"      # 0.5 CPU cores
  memory_limit: "4Gi"      # 4GB RAM
  memory_request: "1Gi"    # 1GB RAM
```

#### **Otimiza√ß√µes Parquet**
```yaml
# Configura√ß√µes otimizadas
parquet_settings:
  page_size_kb: 1024          # 1MB p√°ginas
  block_size_mb: 128          # 128MB blocos
  dictionary_encoding: true    # Ativo para performance
  max_padding_size_mb: 8      # 8MB padding m√°ximo
  dictionary_page_size_kb: 1024 # 1MB dicion√°rio
```

### **Monitoramento Airbyte**

#### **Health Checks**
```bash
# Verificar sa√∫de do servidor Airbyte
curl -f http://airbyte-server:8001/api/v1/health

# Status da conex√£o espec√≠fica
curl -X GET "http://airbyte-server:8001/api/v1/connections/6c7fda57-ebdb-4c6b-9bc3-6b5d5cb9e1ad" \
  -H "accept: application/json"
```

#### **M√©tricas de Performance**
- **Connection Success Rate**: Taxa de sucesso das sincroniza√ß√µes
- **Average Sync Duration**: Tempo m√©dio de sincroniza√ß√£o
- **Data Volume Transferred**: Volume de dados transferidos
- **Error Rate**: Taxa de erros por per√≠odo

---

## ‚ö° Airflow - Orquestra√ß√£o

### **Vers√£o e Ambiente**
- **Vers√£o**: Apache Airflow 2.8.0
- **Executor**: KubernetesExecutor
- **Scheduler**: 1 inst√¢ncia com HA
- **Workers**: Auto-scaling baseado em carga

### **DAG Principal: dag_sync_airbyte_connections**

#### **Estrutura do DAG**
```python
from airflow import DAG
from airflow.providers.airbyte.operators.airbyte import AirbyteTriggerSyncOperator
from airflow.providers.airbyte.sensors.airbyte import AirbyteJobSensor
from airflow.providers.slack.operators.slack_webhook import SlackWebhookOperator

# Configura√ß√£o do DAG
dag = DAG(
    'dag_sync_airbyte_connections',
    description='Sincroniza√ß√£o di√°ria das conex√µes Airbyte',
    schedule_interval='0 2 * * *',  # 2:00 UTC diariamente
    start_date=datetime(2024, 1, 1),
    catchup=False,
    max_active_runs=1,
    default_args={
        'owner': 'data-engineering',
        'depends_on_past': False,
        'email_on_failure': True,
        'email_on_retry': False,
        'retries': 3,
        'retry_delay': timedelta(minutes=10),
        'on_failure_callback': task_fail_slack_alert
    }
)
```

#### **Tasks Principais**

**1. Trigger Sync Radar**
```python
trigger_radar_sync = AirbyteTriggerSyncOperator(
    task_id='trigger_sync_radar',
    airbyte_conn_id='airbyte_default',
    connection_id='6c7fda57-ebdb-4c6b-9bc3-6b5d5cb9e1ad',
    asynchronous=True,
    timeout=3600,  # 1 hora
    wait_seconds=30,
    dag=dag
)
```

**2. Monitor Job Status**
```python
wait_sync_radar = AirbyteJobSensor(
    task_id='wait_sync_radar',
    airbyte_conn_id='airbyte_default',
    airbyte_job_id="{{ ti.xcom_pull(task_ids='trigger_sync_radar')['job_id'] }}",
    timeout=3600,
    poke_interval=60,
    dag=dag
)
```

**3. Notification Success**
```python
notify_success = SlackWebhookOperator(
    task_id='notify_success',
    http_conn_id='slack_webhook',
    message=generate_success_message,
    channel='#data-engineering',
    dag=dag
)
```

#### **Fluxo de Depend√™ncias**
```python
trigger_radar_sync >> wait_sync_radar >> notify_success
```

### **Configura√ß√µes de Sistema**

#### **Variables Airflow**
```json
{
  "airbyte_config": {
    "server_host": "airbyte-server",
    "server_port": 8001,
    "api_version": "v1"
  },
  "radar_connection": {
    "connection_id": "6c7fda57-ebdb-4c6b-9bc3-6b5d5cb9e1ad",
    "timeout": 3600,
    "retry_attempts": 3
  },
  "notification_config": {
    "slack_channel": "#data-engineering",
    "email_alerts": ["data-team@farmarcas.com"]
  }
}
```

#### **Connections Airflow**
```bash
# Conex√£o Airbyte
airflow connections add 'airbyte_default' \
  --conn-type 'airbyte' \
  --conn-host 'airbyte-server' \
  --conn-port 8001

# Conex√£o Slack
airflow connections add 'slack_webhook' \
  --conn-type 'http' \
  --conn-host 'hooks.slack.com' \
  --conn-password 'webhook_token'
```

---

## üóÑÔ∏è MySQL Radar - Source Database

### **Configura√ß√£o do Servidor**

#### **Especifica√ß√µes T√©cnicas**
```yaml
# Detalhes do RDS MySQL
instance_details:
  engine: MySQL 8.0.35
  instance_class: db.r5.xlarge
  cpu_cores: 4
  memory: 32GB
  storage: 500GB GP2
  multi_az: true
  backup_retention: 7 days
  
# Configura√ß√£o de Rede
network_config:
  vpc: vpc-farmarcas-production
  subnet_group: db-subnet-private
  security_group: sg-mysql-radar-production
  public_access: false
```

#### **Connection Details**
```yaml
# Configura√ß√£o de conex√£o
database_config:
  endpoint: db-mysql-radar-production.cxsfxyp2ge90.us-east-2.rds.amazonaws.com
  port: 3306
  database: radar
  username: bi-cognitivo-read
  ssl_mode: preferred
  charset: utf8mb4
  collation: utf8mb4_unicode_ci
```

### **Permiss√µes e Seguran√ßa**

#### **User bi-cognitivo-read**
```sql
-- Permiss√µes do usu√°rio de leitura
GRANT SELECT ON radar.* TO 'bi-cognitivo-read'@'%';
GRANT SHOW VIEW ON radar.* TO 'bi-cognitivo-read'@'%';
GRANT PROCESS ON *.* TO 'bi-cognitivo-read'@'%';
FLUSH PRIVILEGES;
```

#### **SSL Configuration**
```yaml
ssl_settings:
  ssl_ca: rds-ca-2019-root.pem
  ssl_mode: PREFERRED
  ssl_verify_server_cert: false
  require_ssl: true
```

### **Performance e Monitoramento**

#### **Query Performance**
```sql
-- Queries de monitoramento
SELECT 
    table_schema,
    table_name,
    table_rows,
    data_length,
    index_length,
    (data_length + index_length) as total_size
FROM information_schema.tables 
WHERE table_schema = 'radar'
ORDER BY total_size DESC;
```

#### **Connection Monitoring**
```sql
-- Monitorar conex√µes ativas
SELECT 
    USER,
    HOST,
    DB,
    COMMAND,
    TIME,
    STATE
FROM information_schema.PROCESSLIST 
WHERE USER = 'bi-cognitivo-read';
```

---

## ‚òÅÔ∏è AWS S3 - Data Lake Storage

### **Configura√ß√£o do Bucket**

#### **Bucket Details**
```yaml
# Configura√ß√£o S3
bucket_config:
  name: farmarcas-production-bronze
  region: us-east-2
  storage_class: STANDARD
  versioning: Enabled
  encryption: AES-256
  
# Lifecycle Policies
lifecycle_rules:
  - name: "Transition to IA"
    days: 30
    storage_class: STANDARD_IA
  - name: "Transition to Glacier"
    days: 90
    storage_class: GLACIER
  - name: "Delete old versions"
    noncurrent_days: 365
    action: DELETE
```

#### **Path Structure**
```
s3://farmarcas-production-bronze/
‚îî‚îÄ‚îÄ origin=airbyte/
    ‚îî‚îÄ‚îÄ database=bronze_radar/
        ‚îú‚îÄ‚îÄ store/
        ‚îÇ   ‚îî‚îÄ‚îÄ cog_dt_ingestion=2024-01-15/
        ‚îÇ       ‚îú‚îÄ‚îÄ file_store_0.parquet
        ‚îÇ       ‚îú‚îÄ‚îÄ file_store_1.parquet
        ‚îÇ       ‚îî‚îÄ‚îÄ _metadata.json
        ‚îú‚îÄ‚îÄ store_metrics/
        ‚îÇ   ‚îî‚îÄ‚îÄ cog_dt_ingestion=2024-01-15/
        ‚îú‚îÄ‚îÄ user_access/
        ‚îÇ   ‚îî‚îÄ‚îÄ cog_dt_ingestion=2024-01-15/
        ‚îî‚îÄ‚îÄ [80+ tables]/
```

### **Permiss√µes IAM**

#### **Policy para Airbyte**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:PutObjectAcl",
        "s3:GetObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::farmarcas-production-bronze",
        "arn:aws:s3:::farmarcas-production-bronze/*"
      ],
      "Condition": {
        "StringLike": {
          "s3:prefix": "origin=airbyte/database=bronze_radar/*"
        }
      }
    }
  ]
}
```

### **Monitoramento S3**

#### **M√©tricas CloudWatch**
```yaml
# M√©tricas principais
s3_metrics:
  - BucketSizeBytes
  - NumberOfObjects
  - BucketRequests
  - 4xxErrors
  - 5xxErrors
  - FirstByteLatency
  - TotalRequestLatency
```

#### **Alertas Configurados**
```yaml
# CloudWatch Alarms
s3_alarms:
  - name: "S3-HighErrorRate"
    metric: "4xxErrors"
    threshold: 10
    period: 300
    
  - name: "S3-HighLatency"
    metric: "FirstByteLatency"
    threshold: 1000
    period: 300
```

---

## üîç AWS Glue - Schema Discovery

### **Crawlers Configurados**

#### **Crawler: crawler-bronze-radar**
```yaml
# Configura√ß√£o do Crawler
crawler_config:
  name: crawler-bronze-radar
  role: AWSGlueServiceRole-radar
  database: bronze_radar
  schedule: "cron(0 6 * * ? *)"  # 6:00 UTC diariamente
  
# Targets
s3_targets:
  - path: "s3://farmarcas-production-bronze/origin=airbyte/database=bronze_radar/"
    exclusions:
      - "**/_metadata/**"
      - "**/temp/**"
```

#### **Schema Evolution**
```yaml
# Configura√ß√µes de schema
schema_settings:
  schema_change_policy:
    update_behavior: "UPDATE_IN_DATABASE"
    delete_behavior: "LOG"
  
  recrawl_policy:
    recrawl_behavior: "CRAWL_EVERYTHING"
  
  classification: "parquet"
```

### **Data Catalog Integration**

#### **Database Structure**
```sql
-- Estrutura no AWS Glue Data Catalog
DATABASE: bronze_radar
‚îú‚îÄ‚îÄ TABLE: store
‚îú‚îÄ‚îÄ TABLE: store_metrics
‚îú‚îÄ‚îÄ TABLE: user_access
‚îú‚îÄ‚îÄ TABLE: product
‚îú‚îÄ‚îÄ TABLE: contest
‚îî‚îÄ‚îÄ [75+ outras tabelas]
```

---

## üìä Amazon Athena - Query Engine

### **Configura√ß√£o de Workgroup**

#### **Workgroup: radar-analytics**
```yaml
# Configura√ß√£o Athena
workgroup_config:
  name: radar-analytics
  description: "Queries para an√°lise dos dados Radar"
  
  # Performance
  result_configuration:
    output_location: "s3://farmarcas-athena-results/radar/"
    encryption_option: "SSE_S3"
  
  # Cost Control
  bytes_scanned_cutoff_per_query: 1073741824  # 1GB
  enforce_workgroup_configuration: true
  publish_cloudwatch_metrics: true
```

#### **Queries Otimizadas**
```sql
-- Exemplo de query otimizada com parti√ß√µes
SELECT 
    store_id,
    COUNT(*) as total_transactions,
    SUM(amount) as total_amount
FROM bronze_radar.store_metrics
WHERE cog_dt_ingestion >= '2024-01-01'
  AND cog_dt_ingestion <= '2024-01-31'
GROUP BY store_id
ORDER BY total_amount DESC;
```

---

## üîê Seguran√ßa e Compliance

### **Encryption**
- **At Rest**: AES-256 (S3), TDE (MySQL)
- **In Transit**: TLS 1.2+ para todas as conex√µes
- **Keys**: AWS KMS para gerenciamento

### **Access Control**
- **RBAC**: Role-based access control
- **IAM**: Princ√≠pio do menor privil√©gio
- **Audit**: CloudTrail para todas as opera√ß√µes

### **Data Governance**
- **Lineage**: Tracking via AWS Glue
- **Quality**: Valida√ß√µes automatizadas
- **Retention**: Pol√≠ticas de lifecycle S3

---

**üìç Pr√≥ximos Passos:**
- [Pr√©-requisitos](pre_requisitos.md)
- [Configura√ß√µes de Exemplo](configuracoes_exemplo.md)
- [Erros Comuns](erros_comuns.md)
